<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          If you give a Dev a board game... - Journeyman&#39;s Travels
        
    </title>

    <link rel="canonical" href="daniel.scheufler.io/2017/01/31/if-you-give-a-dev-a-board-game/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('')
            /*post*/
        
    }
    
    #signature{
        background-image: url('/img/signature/BeanTechSign-white.png');
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#python" title="python">python</a>
                            
                              <a class="tag" href="/tags/#software" title="software">software</a>
                            
                              <a class="tag" href="/tags/#games" title="games">games</a>
                            
                              <a class="tag" href="/tags/#development" title="development">development</a>
                            
                              <a class="tag" href="/tags/#performance" title="performance">performance</a>
                            
                              <a class="tag" href="/tags/#programming" title="programming">programming</a>
                            
                              <a class="tag" href="/tags/#board game" title="board game">board game</a>
                            
                              <a class="tag" href="/tags/#board games" title="board games">board games</a>
                            
                              <a class="tag" href="/tags/#code" title="code">code</a>
                            
                              <a class="tag" href="/tags/#personal projects" title="personal projects">personal projects</a>
                            
                              <a class="tag" href="/tags/#simulate" title="simulate">simulate</a>
                            
                              <a class="tag" href="/tags/#simulation" title="simulation">simulation</a>
                            
                        </div>
                        <h1>If you give a Dev a board game...</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Daniel Scheufler on
                            2017-01-31
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">A Journeyman&#39;s Travels</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/resume/">Resume</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>From my first lecture on C, I have been tinkering with side projects. I've done projects purely for exploration and entertainment, like a text-based adventure games. More recently I've done utility projects like a script to correct <a href="https://en.wikipedia.org/wiki/Quicken_Interchange_Format" target="_blank" rel="noopener">QIF</a> formatted text. Recently I took on a project of a larger scope.</p>
<p>A while back,I read an <a href="https://boardgamegeek.com/thread/1301080/complete-simulation-machi-koro-strategies" target="_blank" rel="noopener">article about a simulation of Machikoro</a>. It is a ‘city-building game’, with rules that are easy to translate to code. In particular, the idea of using the simulator to ‘evolve’ an optimal strategy for the game captivated me. This was applying Machine-learning to a board game. I figured 'I could do that', and got to work. I encountered many distractions and set-backs, including a new baby. But this month I am pleased to admit that I have hit a milestone.</p>
<p>To support the ‘evolution’ aspect, I had to be able to run thousands of simulations in a reasonable amount of time. And after a bit over a month of concerted effort, I made it. I took my code from being a collection of classes to a library and simulator able to run 1000 games in 15 seconds.</p>
<p>I started back in December with classes to represent the deck of cards, a strategy for play, and a player state. The first step after this was to create a basic <em>AI*</em> to act upon the player state, and a given strategy. Borrowing from the article I had found, I decided to make the strategy more static. The decision logic reduced to constant decisions like 'always yes', or 'always the cheapest available'. Then the <em>AI</em> only needed to use the <em>Strategy</em> to answer queries from the <em>Game</em>.</p>
<h6><span id="note-i-am-capitalizing-and-italicizing-class-names-for-ease-of-identification">*Note: I am capitalizing and <em>italicizing</em> Class names for ease of identification.</span></h6>
<p>After the simplified <em>AI</em> was complete, I got to work on the <em>Game</em>, which would simulate a single game. I decided that I wanted to use <a href="https://github.com/djscheuf/FluentPyTestAPI" target="_blank" rel="noopener">fluent APIs</a> to instantiate a <em>Game</em>. I spend a good chunk of time to get these write, but it helped to make the main routine clearer. While I developed the <em>Game</em>, I decided to abstract the mechanisms of the game. This allowed me to separate the calculations from the sequence in which they are applied. I extracted the <em>Engine</em> to handle things like calculating which <em>AI</em> if any has won, or how much money this <em>AI</em> gets with this dice roll. Meanwhile the <em>Game</em> can manage whose turn it is, and who rolls the dice.</p>
<p>Testing both the <em>Game</em> and the <em>Engine</em> were somewhat arduous, but it was time well spent. I caught numerous bugs, and infinite loops before I ever ran a full simulation. Thankfully the <em>Deck</em>, <em>State</em>, and <em>AI</em> were all similarly tested. But I do wish that I had adhered more tightly to <a href="https://en.wikipedia.org/wiki/Test-driven_development" target="_blank" rel="noopener">TDD</a>. Instead I was very eager to getting the core functionality working.</p>
<p>Once these pieces were in place, I initiated my <a href="https://datasift.github.io/gitflow/IntroducingGitFlow.html" target="_blank" rel="noopener">GitFlow</a>, branching Master, Dev, and a new Feature. After pushing version 1.0 to Git, I started work on a new Feature, multi-game simulation! And while I tinkered with a Simulator, I realized that my fluent APIs had a bug. So I went back to Dev, and produced a <a href="https://en.wikipedia.org/wiki/Hotfix" target="_blank" rel="noopener">Hotfix</a>, which was merged into Master. From there I re-based the Feature, and continued my work.</p>
<p>With the <em>Simulator</em>, I needed to initialize a <em>Game</em>, but also to be able to run it N times, without interference from the previous rounds. So I had a two-pronged approach, I would accumulate the results of each game, and I would allow a <em>Game</em> to be reset. Learning from my forebears, I was sure to include randomization of the first-player when I reset. This removed the skewing of First-move advantage from my results. With the core <em>Game</em> working and fluently initialized, I was able to simple inject it into a <em>Simulator</em> to run.</p>
<p>The original simulator was able to run 1000 games in around 80 seconds. This performance is alright, but my personal dev box has 8 cores and the <em>Simulator</em> was maxing out just one. So to improve performance , I began to look into Python multi-threading. I found two similar flavors of concurrent operations in Python.</p>
<p>I elected to try <a href="https://docs.python.org/3/library/asyncio-task.html" target="_blank" rel="noopener">Tasks</a> first, as it seemed similar to Microsoft’s Task Parallel Library. Sadly I was not quite right about that. The <em>BatchSimulator</em>’s performance was terrible. For some reason it never used multiple cores. The original time for the <em>BatchSimulator</em> was 150 seconds for 1000 games. While it is likely this was user error, it was enough to discourage me from pursuing Tasks further.</p>
<p>So I turned to <a href="https://docs.python.org/3/library/concurrent.futures.html" target="_blank" rel="noopener">concurrents</a>. And with concurrents, I had much better luck. In this case I spawned some sub-processes. I created the <em>Coordinator</em> to provide each fork with its own copy of the given <em>Game</em>, and an assigned number of games to run. Then each fork created its own <em>Simulator</em>, and ran the given number of games. Once each <em>Simulator</em> completed, the <em>Coordinator</em> would accumulate the results. After all the forks completed, the coordinator calculates the final statistics. This provides an overall winner. To make this easier, I extracted the <em>SimulationResults</em> class. I then added public methods for merging and calculations. By leveraging sub-processes, and existing code, the <em>Coordinator</em> was able to run at least 1000 games in ~16 seconds. Now I say at least, because the <em>Coordinator</em> divides the games evenly among the sub-processes. So to ensure that at least 1000 games are run, it must round up on the division of games per sub-process. But having more data is never a bad thing.</p>
<p>I was able to push and close this Feature recently, and I am very pleased with the progress. I went from single game simulation to rather performant 1000 game simulation in a month. I now have something to show for my ideas and my work. This milestone leaves me at a good break point. I can either continue working on the simulator to pursue the machine-learning angle. Or I can change focus and return to this project later. At the moment, I don’t know what direction I will turn. But I wanted to take a step back and look at what I have accomplished, and share my ‘geeking out’ a bit.</p>
<p>If anyone is interested in the source, you can find it <a href="https://github.com/djscheuf/Machikoro-Simulator" target="_blank" rel="noopener">here</a>.</p>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2017/02/07/Dungeons-and-Dragons-and-Leadership-Training/" data-toggle="tooltip" data-placement="top" title="Dungeons and Dragons and Leadership Training?">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2017/01/24/to-build-a-better-performance-review/" data-toggle="tooltip" data-placement="top" title="To build a better performance review">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#python" title="python">python</a>
                        
                          <a class="tag" href="/tags/#software" title="software">software</a>
                        
                          <a class="tag" href="/tags/#games" title="games">games</a>
                        
                          <a class="tag" href="/tags/#development" title="development">development</a>
                        
                          <a class="tag" href="/tags/#performance" title="performance">performance</a>
                        
                          <a class="tag" href="/tags/#programming" title="programming">programming</a>
                        
                          <a class="tag" href="/tags/#board game" title="board game">board game</a>
                        
                          <a class="tag" href="/tags/#board games" title="board games">board games</a>
                        
                          <a class="tag" href="/tags/#code" title="code">code</a>
                        
                          <a class="tag" href="/tags/#personal projects" title="personal projects">personal projects</a>
                        
                          <a class="tag" href="/tags/#simulate" title="simulate">simulate</a>
                        
                          <a class="tag" href="/tags/#simulation" title="simulation">simulation</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>









    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/djscheuf">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://www.linkedin.com/in/danielscheufler">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Daniel Scheufler 2018 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://beantech.org">BeanTech</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=YenYuHsuan&repo=hexo-theme-beantech&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("daniel.scheufler.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="daniel.scheufler.io/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
